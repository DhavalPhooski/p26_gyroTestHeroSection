<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Spritesheet Demo - Parallax with Gyro</title>
        <link rel="stylesheet" href="optimized-parallax.css" />
    </head>
    <body>
        <div class="HomePage">
            <div class="HeroSection" id="hero">
                <div class="sprite title" data-depth="0.15"></div>
                <div class="sprite baseClouds" data-depth="0.65"></div>
                <div class="sprite baseClouds2" data-depth="0.65"></div>
                <div class="WindMillParent" data-depth="0.25">
                    <div class="sprite staticWindMill"></div>
                    <div class="sprite rotatingWindMill"></div>
                </div>
                <div class="WaterMillParent" data-depth="0.25">
                    <div class="sprite rotatingWaterMill1"></div>
                    <div class="sprite rotatingWaterMill2"></div>
                    <div class="sprite staticWaterMill"></div>
                    <div class="sprite Water"></div>
                </div>
                <div class="sprite titleCloud1" data-depth="0.5"></div>
                <div class="sprite titleCloud2" data-depth="0.7"></div>
                <div class="sprite titleCloud3" data-depth="0.10"></div>
                <div class="sprite stars"></div>
                <div class="sprite geometricCircleGrid"></div>
                <div class="sprite babbageMachine" data-depth="0.25"></div>
            </div>

            <div class="hourGlassLeftParent">
                <div class="sprite hourGlassLeftPillar"></div>
            </div>
            <div class="hourGlassRightParent">
                <div class="sprite hourGlassRightPillar"></div>
            </div>
            <div class="hourGlassTopParent">
                <div class="sprite hourGlassTop"></div>
            </div>
            <div class="hourGlassBaseParent">
                <div class="sprite hourGlassBase"></div>
            </div>
            <div class="MiddleSection">
                <div class="sprite MobileHourGlassLeftMiddle"></div>
                <div class="sprite MobileHourGlassRightMiddle"></div>

                <div class="sprite purpleClouds1"></div>
                <div class="sprite purpleClouds2"></div>
                <div class="sprite girlFall"></div>
                <div class="sprite guyFall"></div>
                <div class="sprite peachClouds1"></div>
                <div class="sprite peachClouds2"></div>

            </div>
            <div class="MiddleSection Shine">
                <div class="sprite upShine"></div>
                <div class="sprite downShine"></div>
            </div>
            <div class="FutureParent">
                <div class="sprite bgFutureBuild"></div>
                <div class="sprite bgFutureBuild2"></div>
                <div class="sprite foreGroundRoad"></div>
                <div class="BridgeAndTrainParent">
                    <div class="sprite train"></div>
                    <div class="sprite bridge"></div>
                </div>
            </div>
        </div>

        <!-- Gyro Enable Button (only shows on mobile) -->
        <button id="gyroBtn" style="
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        " onmouseover="this.style.transform='translateX(-50%) scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(0, 0, 0, 0.3)'" 
           onmouseout="this.style.transform='translateX(-50%) scale(1)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.2)'">
            ðŸŽ¯ Enable Gyro Parallax
        </button>

        <!-- Optional: Visual debug info -->
        <div class="debug-info" id="debug">
            Mouse: <span id="mousePos">0, 0</span><br>
            Offset: <span id="offset">0px</span><br>
            FPS: <span id="fps">60</span><br>
            Mode: <span id="mode">Mouse</span>
        </div>

        <script>
        // ============================================
        // ðŸŽ® PARALLAX ENGINE - OPTIMIZED WITH GYRO SUPPORT
        // ============================================

        // Cache DOM references
        const hero = document.getElementById("hero");
        const layers = hero.querySelectorAll("[data-depth]");
        const gyroBtn = document.getElementById("gyroBtn");
        
        // Debug elements
        const debugMousePos = document.getElementById("mousePos");
        const debugOffset = document.getElementById("offset");
        const debugFPS = document.getElementById("fps");
        const debugMode = document.getElementById("mode");

        // ============================================
        // ðŸ“Š STATE MANAGEMENT
        // ============================================
        let currentX = 0;      // Current position (smoothed)
        let targetX = 0;       // Target position
        let raf = null;        // RequestAnimationFrame ID
        let gyroEnabled = false;  // Gyro state
        let gyroSupported = false; // Device capability
        
        // FPS tracking
        let lastFrameTime = performance.now();
        let fps = 60;
        
        // Gyro throttling
        let lastGyroTime = 0;
        const GYRO_THROTTLE = 16; // ~60fps (1000ms / 60 = 16.67ms)

        // ============================================
        // âš™ï¸ CONFIGURATION
        // ============================================
        const MAX_MOVE = 80;     // Maximum pixels to move
        const SMOOTHING = 0.08;  // Smoothing factor
        const GYRO_SENSITIVITY = 1.5; // Gyro multiplier (adjust for intensity)

        // ============================================
        // ðŸ’¾ PRESERVE ORIGINAL TRANSFORMS
        // ============================================
        const baseTransforms = new WeakMap();
        
        layers.forEach(layer => {
            const computedStyle = getComputedStyle(layer);
            const currentTransform = computedStyle.transform;
            baseTransforms.set(
                layer,
                currentTransform === "none" ? "" : currentTransform
            );
            
            // Performance optimization: hint browser about transforms
            layer.style.willChange = 'transform';
        });

        // ============================================
        // ðŸ“± DETECT MOBILE DEVICE
        // ============================================
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                || (window.innerWidth <= 768);
        }

        // ============================================
        // ðŸŽ¯ GYRO SUPPORT DETECTION
        // ============================================
        function detectGyroSupport() {
            // Check if DeviceOrientation API exists
            if (window.DeviceOrientationEvent) {
                // iOS 13+ requires permission
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    gyroSupported = true;
                    console.log("ðŸ“± iOS device detected - permission required");
                } 
                // Android and older iOS
                else if ('ondeviceorientation' in window) {
                    gyroSupported = true;
                    console.log("ðŸ“± Android device detected - gyro available");
                }
            }
            
            // Show button only on mobile with gyro support
            if (isMobile() && gyroSupported) {
                gyroBtn.style.display = 'block';
            }
        }

        // ============================================
        // ðŸ” REQUEST GYRO PERMISSION (iOS 13+)
        // ============================================
        async function requestGyroPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        console.log("âœ… iOS gyro permission granted");
                        return true;
                    } else {
                        console.log("âŒ iOS gyro permission denied");
                        return false;
                    }
                } catch (error) {
                    console.error("âŒ Error requesting gyro permission:", error);
                    return false;
                }
            }
            // Android or older iOS - no permission needed
            return true;
        }

        // ============================================
        // ðŸŽ² GYRO EVENT HANDLER (X-AXIS ONLY - OPTIMIZED)
        // ============================================
        function onGyroMove(event) {
            // Throttle gyro events to prevent lag
            const now = performance.now();
            if (now - lastGyroTime < GYRO_THROTTLE) return;
            lastGyroTime = now;
            
            // DeviceOrientation:
            // - gamma: left-to-right tilt (-90 to 90) â†’ X axis
            let gamma = event.gamma; // Left-right tilt
            
            // Handle null values (some devices)
            if (gamma === null) return;

            // Normalize gamma to -1 to 1 range
            // gamma ranges from -90 to 90, we use -45 to 45 for better control
            const normalizedX = Math.max(-1, Math.min(1, gamma / 45)) * GYRO_SENSITIVITY;
            
            // Apply maximum movement constraint (X-axis only, like mouse)
            targetX = normalizedX * MAX_MOVE;
            
            // Update debug info
            if (debugMousePos) {
                debugMousePos.textContent = `Î³:${gamma.toFixed(1)}Â°`;
            }
            
            // Start RAF loop if not running
            if (!raf) {
                raf = requestAnimationFrame(update);
            }
        }

        // ============================================
        // ðŸ–±ï¸ MOUSE MOVE HANDLER (X-AXIS ONLY)
        // ============================================
        function onMouseMove(e) {
            // Don't process mouse if gyro is active
            if (gyroEnabled) return;
            
            const normalizedX = (e.clientX / window.innerWidth) * 2 - 1;
            targetX = normalizedX * MAX_MOVE;
            
            if (debugMousePos) {
                debugMousePos.textContent = `${e.clientX}, ${e.clientY}`;
            }
            
            if (!raf) {
                raf = requestAnimationFrame(update);
            }
        }

        // ============================================
        // ðŸŽ¬ UPDATE LOOP (OPTIMIZED - X-AXIS ONLY)
        // ============================================
        function update(timestamp) {
            // Calculate FPS
            const delta = timestamp - lastFrameTime;
            fps = Math.round(1000 / delta);
            lastFrameTime = timestamp;
            
            if (debugFPS) {
                debugFPS.textContent = fps;
            }

            // Smooth easing for X-axis only
            currentX += (targetX - currentX) * SMOOTHING;

            // Apply transforms to all layers (batch update for performance)
            layers.forEach(layer => {
                const depth = Number(layer.dataset.depth);
                const offsetX = currentX * depth;
                
                if (debugOffset && layer === layers[0]) {
                    debugOffset.textContent = `${offsetX.toFixed(2)}px`;
                }

                // Apply transform (X-axis only, like original mouse parallax)
                // Use will-change hint for better performance
                layer.style.transform = 
                    `translate3d(${offsetX}px, 0, 0) ${baseTransforms.get(layer)}`;
            });

            // Continue loop if still moving (stricter threshold for better sleep)
            if (Math.abs(targetX - currentX) > 0.05) {
                raf = requestAnimationFrame(update);
            } else {
                raf = null;
            }
        }

        // ============================================
        // ðŸ”˜ GYRO BUTTON CLICK HANDLER
        // ============================================
        gyroBtn.addEventListener('click', async function() {
            if (!gyroEnabled) {
                // Request permission if needed
                const permitted = await requestGyroPermission();
                
                if (permitted) {
                    // Enable gyro
                    gyroEnabled = true;
                    window.addEventListener('deviceorientation', onGyroMove, { passive: true });
                    hero.removeEventListener('mousemove', onMouseMove);
                    
                    // Update button
                    this.textContent = 'ðŸŽ¯ Gyro Active';
                    this.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                    
                    if (debugMode) debugMode.textContent = 'Gyro';
                    console.log("âœ… Gyro parallax enabled");
                } else {
                    alert('Gyro permission denied. Please enable motion sensors in your browser settings.');
                }
            } else {
                // Disable gyro
                gyroEnabled = false;
                window.removeEventListener('deviceorientation', onGyroMove);
                hero.addEventListener('mousemove', onMouseMove);
                
                // Reset position smoothly
                targetX = 0;
                if (!raf) raf = requestAnimationFrame(update);
                
                // Update button
                this.textContent = 'ðŸŽ¯ Enable Gyro Parallax';
                this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                
                if (debugMode) debugMode.textContent = 'Mouse';
                console.log("â¸ï¸ Gyro parallax disabled");
            }
        });

        // ============================================
        // ðŸš€ INITIALIZATION
        // ============================================
        function init() {
            // Detect gyro support
            detectGyroSupport();
            
            // Always enable mouse parallax initially (with passive listener)
            hero.addEventListener("mousemove", onMouseMove, { passive: true });
            
            console.log("âœ… Parallax engine initialized");
            console.log("ðŸ“Š Configuration:", { MAX_MOVE, SMOOTHING, GYRO_SENSITIVITY });
            console.log("ðŸ“± Mobile:", isMobile());
            console.log("ðŸŽ¯ Gyro supported:", gyroSupported);
        }

        // Start the engine
        init();

        // ============================================
        // ðŸ§¹ CLEANUP
        // ============================================
        window.addEventListener('beforeunload', () => {
            hero.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('deviceorientation', onGyroMove);
            if (raf) cancelAnimationFrame(raf);
        });
    </script>
    </body>
</html>